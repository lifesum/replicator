---
version: 1.2
name: replicator
tasks:
  - name: agent
    cluster_target: api
    command: ['/replicator agent -nomad=$NOMAD_HOST']
    resources:
      cpu_reservation: 256
      memory_reservation: 256
    type: worker
environment:
  NOMAD_HOST: 'nomad.$(SYSTEM_DOMAIN)'
provisioning:
  image: lifesum-docker/base:latest
  commands:
  - command: shell
    config:
      commands:
      - mkdir -p /go/src/github.com/elsevier-core-engineering/
  - command: src-copy
    config:
      destination: /go/src/github.com/elsevier-core-engineering/replicator
  - command: apk-packages
    config:
      add:
      - alpine-sdk
      - go
  - command: shell
    config:
      commands:
      - cd /go/src/github.com/elsevier-core-engineering/replicator && GOPATH=/go make
      - cp /go/bin/replicator /replicator && rm -rf /go
  - command: apk-packages
    config:
      remove:
      - alpine-sdk
      - go
